name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  release:
    types: [published]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: pyproject.toml

      - run: pip install -e ".[dev,sign]"

      - run: pytest -v

      - run: ruff check .

      - run: ruff format --check .

      - run: pytest examples/test_demo.py -v --cov-append

  node-schema-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: CJS require test
        run: node packages/schema/tests/test_cjs_require.cjs

      - name: Schema fields test
        run: node packages/schema/tests/test_schema_fields.mjs

      - name: Ajv edge cases test
        run: node packages/schema/tests/test_ajv_edge_cases.mjs

      - name: Product-line test
        run: node packages/schema/tests/test_product_line.mjs

      - name: Validate examples
        run: node examples/validate.mjs

  version-check:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Verify versions match tag
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          PY_VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          NPM_VERSION=$(node -p "require('./packages/schema/package.json').version")

          echo "Tag:          v${TAG_VERSION}"
          echo "pyproject:    ${PY_VERSION}"
          echo "package.json: ${NPM_VERSION}"

          if [ "$PY_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: pyproject.toml version ($PY_VERSION) != tag ($TAG_VERSION)"
            exit 1
          fi
          if [ "$NPM_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: package.json version ($NPM_VERSION) != tag ($TAG_VERSION)"
            exit 1
          fi
          echo "All versions consistent."

  publish-pypi:
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'release'
    needs: [test, node-schema-tests, version-check]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: pip

      - run: pip install build

      - run: python -m build

      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_TOKEN }}
          skip_existing: true

  publish-npm:
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'release'
    needs: [test, node-schema-tests, version-check]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    defaults:
      run:
        working-directory: packages/schema
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Copy schemas
        run: |
          cp ../../spec/schemas/llmindex-0.1.schema.json schemas/
          cp ../../spec/schemas/llmindex-0.2.schema.json schemas/
          cp ../../spec/schemas/product-line-0.1.schema.json schemas/

      - run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
